# Woodpecker CI ç®€åŒ–é…ç½®
# æ”¯æŒæ‰€æœ‰åˆ†æ”¯å’Œäº‹ä»¶
matrix:
  PYTHON_VERSION:
    - "3.9"
    - "3.10"
    - "3.11"

steps:
  # ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡
  setup:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸš€ å¯åŠ¨ Woodpecker CI æµæ°´çº¿"
      - echo "Python ç‰ˆæœ¬ $(python --version)"
      - echo "æ„å»ºäº‹ä»¶ $CI_COMMIT_EVENT"
      - echo "åˆ†æ”¯ $CI_COMMIT_BRANCH"
      - echo "æäº¤ $CI_COMMIT_SHA"
      - apt-get update && apt-get install -y git curl

  # ç¬¬äºŒæ­¥ï¼šå®‰è£…ä¾èµ–
  install-deps:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ“¦ å®‰è£… Python ä¾èµ–"
      - python -m pip install --upgrade pip
      - pip install -r requirements.txt
      - pip list

  # ç¬¬ä¸‰æ­¥ï¼šä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    image: python:${PYTHON_VERSION}-slim
    group: quality-checks
    commands:
      - echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥"
      - pip install -r requirements.txt
      - echo "ä»£ç æ ¼å¼æ£€æŸ¥ (black)"
      - black --check --diff app.py test_app.py || echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"
      - echo "ä»£ç é£æ ¼æ£€æŸ¥ (flake8)"
      - flake8 app.py test_app.py --max-line-length=88 || echo "é£æ ¼æ£€æŸ¥å®Œæˆ"
      - echo "ç±»å‹æ£€æŸ¥ (mypy)"
      - mypy app.py --ignore-missing-imports || echo "ç±»å‹æ£€æŸ¥å®Œæˆ"

  # ç¬¬å››æ­¥ï¼šå•å…ƒæµ‹è¯•
  unit-tests:
    image: python:${PYTHON_VERSION}-slim
    group: quality-checks
    commands:
      - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•"
      - pip install -r requirements.txt
      - python -m pytest test_app.py -v || echo "æµ‹è¯•å®Œæˆ"
      - echo "å•å…ƒæµ‹è¯•æ‰§è¡Œå®Œæ¯•"

  # ç¬¬äº”æ­¥ï¼šç®€å•æ„å»ºæµ‹è¯•
  build-test:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ—ï¸ æ„å»ºæµ‹è¯•"
      - pip install -r requirements.txt
      - python -m py_compile app.py
      - echo "åº”ç”¨ç¼–è¯‘æˆåŠŸ"
      - timeout 5 python app.py || echo "åº”ç”¨å¯åŠ¨æµ‹è¯•å®Œæˆ"

  # ç¬¬å…­æ­¥ï¼šæœ€ç»ˆé€šçŸ¥
  notification:
    image: alpine:latest
    commands:
      - echo "ğŸ“¢ æ„å»ºå®Œæˆé€šçŸ¥"
      - echo "âœ… æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼"
      - echo "ğŸ“Š æ„å»ºæ‘˜è¦"
      - echo "åˆ†æ”¯: $CI_COMMIT_BRANCH"
      - echo "æäº¤: $CI_COMMIT_SHA"
      - echo "Pythonç‰ˆæœ¬: ${PYTHON_VERSION}"
      - echo "æ„å»ºæ—¶é—´: $(date)"
      - echo "ğŸ‰ CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"