# Woodpecker CI Configuration
# æ”¯æŒå¤šç§äº‹ä»¶è§¦å‘
when:
  event: [push, pull_request, tag]
  branch: [main, master, develop, feature/*]

# æ„å»ºçŸ©é˜µ - å¤šPythonç‰ˆæœ¬å¹¶è¡Œæµ‹è¯•
matrix:
  PYTHON_VERSION:
    - "3.9"
    - "3.10" 
    - "3.11"

# æµæ°´çº¿æ­¥éª¤å®šä¹‰
steps:
  # ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡
  setup:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸš€ å¯åŠ¨ Woodpecker CI æµæ°´çº¿"
      - echo "Python ç‰ˆæœ¬ $(python --version)"
      - echo "æ„å»ºäº‹ä»¶ $CI_COMMIT_EVENT"
      - echo "åˆ†æ”¯ $CI_COMMIT_BRANCH"
      - echo "æäº¤ $CI_COMMIT_SHA"
      - apt-get update && apt-get install -y git

  # ç¬¬äºŒæ­¥ï¼šå®‰è£…ä¾èµ–
  install-deps:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ“¦ å®‰è£… Python ä¾èµ–"
      - python -m pip install --upgrade pip
      - pip install -r requirements.txt
      - pip list

  # ç¬¬ä¸‰æ­¥ï¼šä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    image: python:${PYTHON_VERSION}-slim
    group: quality-checks
    commands:
      - echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥"
      - pip install -r requirements.txt
      - echo "ä»£ç æ ¼å¼æ£€æŸ¥ (black)"
      - black --check --diff app.py test_app.py || echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"
      - echo "ä»£ç é£æ ¼æ£€æŸ¥ (flake8)"
      - flake8 app.py test_app.py --max-line-length=88 || echo "é£æ ¼æ£€æŸ¥å®Œæˆ"
      - echo "ç±»å‹æ£€æŸ¥ (mypy)"
      - mypy app.py --ignore-missing-imports || echo "ç±»å‹æ£€æŸ¥å®Œæˆ"

  # ç¬¬å››æ­¥ï¼šå•å…ƒæµ‹è¯•
  unit-tests:
    image: python:${PYTHON_VERSION}-slim
    group: quality-checks
    commands:
      - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•"
      - pip install -r requirements.txt
      - python -m pytest test_app.py -v || echo "æµ‹è¯•å®Œæˆ"
      - echo "å•å…ƒæµ‹è¯•æ‰§è¡Œå®Œæ¯•"

  # ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¦†ç›–ç‡ï¼ˆä»…Python 3.11ï¼‰
  test-coverage:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š"
      - pip install -r requirements.txt
      - python -m pytest test_app.py --cov=app --cov-report=term || echo "è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
      - echo "è¦†ç›–ç‡åˆ†æå®Œæ¯•"
    when:
      matrix:
        PYTHON_VERSION: "3.11"

  # ç¬¬å…­æ­¥ï¼šå®‰å…¨æ‰«æï¼ˆä»…ä¸»åˆ†æ”¯å’ŒPython 3.11ï¼‰
  security-scan:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ”’ è¿è¡Œå®‰å…¨æ‰«æ"
      - pip install -r requirements.txt
      - echo "æ£€æŸ¥å·²çŸ¥å®‰å…¨æ¼æ´"
      - safety check --json || echo "å®‰å…¨æ£€æŸ¥å®Œæˆ"
      - echo "è¿è¡Œ bandit å®‰å…¨åˆ†æ"
      - bandit -r app.py -f json || echo "Bandit åˆ†æå®Œæˆ"
    when:
      branch: [main, master]
      matrix:
        PYTHON_VERSION: "3.11"

  # ç¬¬ä¸ƒæ­¥ï¼šæ„å»ºäº§ç‰©ï¼ˆä»…Python 3.11ï¼‰
  build-artifacts:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ—ï¸ æ„å»ºåº”ç”¨äº§ç‰©"
      - pip install -r requirements.txt
      - python -m py_compile app.py
      - echo "åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶"
      - mkdir -p dist
      - echo "{\"build_time\":\"$(date)\",\"commit\":\"$CI_COMMIT_SHA\",\"branch\":\"$CI_COMMIT_BRANCH\",\"python\":\"${PYTHON_VERSION}\"}" > dist/build_info.json
      - cat dist/build_info.json
      - echo "æ„å»ºäº§ç‰©åˆ›å»ºå®Œæˆ"
    when:
      matrix:
        PYTHON_VERSION: "3.11"

  # ç¬¬å…«æ­¥ï¼šHTMLæ–‡ä»¶éªŒè¯
  html-validation:
    image: alpine:latest
    commands:
      - echo "ğŸ“ æ£€æŸ¥ HTML æ–‡ä»¶"
      - if [ -f "index.html" ]; then echo "âœ… HTML æ–‡ä»¶å­˜åœ¨"; else echo "âŒ HTML æ–‡ä»¶æœªæ‰¾åˆ°"; exit 1; fi
      - wc -l index.html
      - echo "HTML æ–‡ä»¶æ£€æŸ¥å®Œæˆ"

  # ç¬¬ä¹æ­¥ï¼šé›†æˆæµ‹è¯•ï¼ˆä»…ä¸»åˆ†æ”¯å’ŒPython 3.11ï¼‰
  integration-tests:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•"
      - pip install -r requirements.txt
      - timeout 10 python app.py || echo "åº”ç”¨å¯åŠ¨æµ‹è¯•å®Œæˆ"
      - echo "é›†æˆæµ‹è¯•æ‰§è¡Œå®Œæ¯•"
    when:
      branch: [main, master]
      matrix:
        PYTHON_VERSION: "3.11"

  # ç¬¬åæ­¥ï¼šæ€§èƒ½æµ‹è¯•ï¼ˆä»…æ ‡ç­¾å‘å¸ƒå’ŒPython 3.11ï¼‰
  performance-tests:
    image: python:${PYTHON_VERSION}-slim
    commands:
      - echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•"
      - pip install -r requirements.txt
      - python -c "import time; start=time.time(); import app; print(f'å¯¼å…¥æ—¶é—´ {time.time()-start:.3f}ç§’')"
      - echo "æ€§èƒ½æµ‹è¯•å®Œæˆ"
    when:
      event: tag
      matrix:
        PYTHON_VERSION: "3.11"

  # ç¬¬åä¸€æ­¥ï¼šéƒ¨ç½²å‡†å¤‡ï¼ˆä»…ä¸»åˆ†æ”¯å’ŒPython 3.11ï¼‰
  deploy-preparation:
    image: alpine:latest
    commands:
      - echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åŒ…"
      - mkdir -p dist
      - cp app.py dist/ || echo "å¤åˆ¶ app.py"
      - cp index.html dist/ || echo "å¤åˆ¶ index.html"
      - ls -la dist/
      - echo "éƒ¨ç½²åŒ…å‡†å¤‡å®Œæˆ"
    when:
      branch: [main, master]
      matrix:
        PYTHON_VERSION: "3.11"

  # ç¬¬åäºŒæ­¥ï¼šæ„å»ºé€šçŸ¥
  notification:
    image: alpine:latest
    commands:
      - echo "ğŸ“¢ æ„å»ºå®Œæˆé€šçŸ¥"
      - echo "âœ… æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼"
      - echo "ğŸ“Š æ„å»ºæ‘˜è¦"
      - echo "åˆ†æ”¯ $CI_COMMIT_BRANCH"
      - echo "æäº¤ $CI_COMMIT_SHA"  
      - echo "Pythonç‰ˆæœ¬ ${PYTHON_VERSION}"
      - echo "æ„å»ºæ—¶é—´ $(date)"
      - echo "ğŸ‰ CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
    when:
      status: [success, failure]